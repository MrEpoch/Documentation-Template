---
title: Directus Authentikace
description: Directus CMS authentikace
---

## Příprava

První stáhneme directus a připravíme složku podle:
[Directus nastavení](/docs/libs/directus)

Na directusu musíme vypnout email verify v **`/settings/project` user registration**

<Note title="Poznámka" type="success">
  Pokud máme vlastní mail SMTP server nemusíme ale jináč se nebude nikdo moct
  přihlásit protože nelze poslat ověřovací email.
</Note>

### Změníme `directus.ts`

```typescript
import { createDirectus, rest, authentication } from "@directus/sdk";

const directus = createDirectus(process.env.DIRECTUS_URL)
  .with(authentication("json", { credentials: "include", autoRefresh: true }))
  .with(rest({ credentials: "include" }));

export default directus;
```

- musíme do složky `.env.local` přidat `DIRECTUS_URL`, místo kde je directus hostovaný např `https://directus.example.com`
- používá JWT token pro authentikaci

## Server akce

Celé authentikace bude v nextjs server akcích

### Typescript

```typescript
export interface userTokenType {
  accessToken: string;
  refreshToken: string;
  expiresAt: number;
}
```

### Akce

```typescript
'use server';
import { cookies } from "next/headers";
import directus from "./directus";
import { registerUser, refresh, logout } from "@directus/sdk";
import { userTokenType } from "@/types";

export async function handleLogout() {
  const user = await userSession();
  await directus.request(
    logout(user.refreshToken)
  )
  cookies().delete(process.env.DIRECTUS_COOKIE_NAME);
}

export async function userSession() {
  let token = undefined;
  const cookie = cookies().get(process.env.DIRECTUS_COOKIE_NAME);
  if (cookie?.value) {
    token = JSON.parse(cookie?.value);
  }

  const user = {} as userTokenType;

  if (token != undefined) {
    user.accessToken = token.data.access_token;
    user.refreshToken = token.data.refresh_token;
    user.expiresAt = token.data.expires_at;
  }

  return user;
}

export async function getAccessToken {
  const user = await userSession();
  const token = await directus.request(
    refresh("json", user.refreshToken)
  );
  cookies().set(COOKIE_NAME, JSON.stringify(token));
  return user.accessToken;
}

export async function RegisterDirectus(data: { email: string, password: string }) {
  try {
    const { email, password } = data;
    const result = await directus.request(
      registerUser(email, password)
    );

    return { message: "Účet vytvořen!", status: 200 };
  } catch (e: any) {
    console.log(e);
    const code = e.errors[0].extensions.code;
    if (code === "RECORD_NOT_UNIQUE") {
      return { message: "Tenhle uživatel již existuje.", status: 400 };
    }
    return {
      message: "Nastala neočekávaná chyba.",
      status: 500,
    }
  }
}

export async function LoginDirectus(data: { email: string, password: string }) {
  try {
    const { email, password } = data;
    const result = await directus.login(email, password);
    cookies().set(process.env.DIRECTUS_COOKIE_NAME, JSON.stringify(result));

    return { message: "Přihlášen!", status: 200 };
  } catch (e: any) {
    console.log(e);
    const code = e.errors[0].extensions.code;
    if (code === "INVALID_CREDENTIALS") {
      return { message: "Nesprávné heslo.", status: 400 };
    }
    return {
      message: "Nastala neočekávaná chyba.",
      status: 500,
    }
  }
}
```

- Nesmí se zapomenout na validaci dat z klienta přes [zod](/docs/libs/zod)

## Integrace

- [Auth form](/docs/components/auth-form)
- [Zod validace](/docs/libs/zod)

## Reference na zdroje
